<span class="page-title">
    <i class="pi pi-chevron-right"></i> Comparar Serviços de Transferência
</span>

<div class="form-panel">

    @if (loading()) {
    <app-loader />
    } @else {
    <div class="flex justify-end pb-2.5">
        <p-button label="Adicionar Serviço..." severity="secondary" (click)="showDialogServicos = true">
            <i class="pi pi-plus text-2xl"></i>
        </p-button>
    </div>

    <p-divider />

    <div class="flex gap-4 items-center">

        <div class="flex-1 flex items-center justify-center">
            <label class="whitespace-nowrap">
                Valor IOF:
            </label>
        </div>

        <div class="flex-1">
            <p-inputgroup>
                <p-inputnumber locale="pt-BR" [minFractionDigits]="2" [maxFractionDigits]="2" [(ngModel)]="iof" [disabled]="true" />
                <p-inputgroup-addon>
                    <i class="pi pi-percentage"></i>
                </p-inputgroup-addon>
            </p-inputgroup>
        </div>

        <div class="flex-1 flex items-center justify-center">
            <label class="whitespace-nowrap">
                Valor do SPOT:
            </label>
        </div>

        <div class="flex-1">
            <p-inputgroup>
                <p-inputgroup-addon>
                    <i class="pi pi-money-bill"></i>
                </p-inputgroup-addon>
                <p-inputnumber locale="pt-BR" [minFractionDigits]="2" [maxFractionDigits]="3" [(ngModel)]="spot" [disabled]="true" />
            </p-inputgroup>
        </div>

        <div class="flex-1 flex items-center justify-center">
            <label class="whitespace-nowrap">
                Transferência de:
            </label>
        </div>

        <div class="flex-1 flex items-center">
            <p-inputgroup>
                <p-inputgroup-addon>
                    <i class="pi pi-money-bill"></i>
                </p-inputgroup-addon>
                <p-inputnumber locale="pt-BR" [minFractionDigits]="2" [maxFractionDigits]="3" [(ngModel)]="valor" />
            </p-inputgroup>
        </div>

        <div class="flex-1 flex items-center justify-center">
            <label class="whitespace-nowrap">
                Valor da Cotação:
            </label>
        </div>

        <div class="flex-1 flex items-center">
            <p-inputgroup>
                <p-inputgroup-addon>
                    <i class="pi pi-money-bill"></i>
                </p-inputgroup-addon>
                <p-inputnumber locale="pt-BR" [minFractionDigits]="2" [maxFractionDigits]="3" [(ngModel)]="taxa" [disabled]="true"/>
            </p-inputgroup>
        </div>

        <div class="flex-none flex items-center">
            <p-button icon="pi pi-search" severity="success" (click)="openCotacaoDialog()" />
        </div>

    </div>

    <div class="mt-8 pt-8">

        <table class="p-datatable-table fix-height">
            <thead class="p-datatable-thead" style="position: sticky;">
                <tr>
                    <th> Nome do Serviço</th>
                    @for (servico of servicosSelecionados; track $index) {
                    <th class="force-center">{{servico.nome}}</th>
                    }
                </tr>
            </thead>

            <tbody class="p-datatable-tbody">
                <tr>
                    <td> SPRED </td>
                    @for (servico of servicosSelecionados; track $index) {
                    <td class="force-center">{{servico.spred | number: '1.2-2' : 'pt-BR' }}%</td>
                    }
                </tr>
                <tr>
                    <td> Taxas </td>
                    @for (servico of servicosSelecionados; track $index) {
                    <td class="force-center">
                        @if(servico.custoVariavel){
                        <p-inputnumber locale="pt-BR" [minFractionDigits]="2" [maxFractionDigits]="3" [(ngModel)]="servico.taxas" />
                        }
                        @else {
                        {{moedaDestino?.simbolo}} {{servico.taxas | number: '1.2-2' : 'pt-BR' }}
                        }
                    </td>
                    }
                </tr>
                <tr>
                    <td> Total Bruto </td>
                    @for (servico of servicosSelecionados; track $index) {
                    <td class="force-center">{{moedaDestino?.simbolo}} {{calcularTotalBruto(servico) | number: '1.2-2' : 'pt-BR' }}</td>
                    }
                </tr>
                <tr>
                    <td> <b>Total Final</b> </td>
                    @for (servico of servicosSelecionados; track $index) {
                    <td class="force-center">{{moedaDestino?.simbolo}} {{calcularTotalLiquido(servico) | number: '1.2-2' : 'pt-BR' }}</td>
                    }
                </tr>

                <tr>
                    <td> </td>
                    @for (servico of servicosSelecionados; track $index) {
                    <td class="force-center">
                        <p-button label="Efetuar" severity="secondary" size="small" (click)="openDialog(servico)" />
                    </td>
                    }
                </tr>
            </tbody>
        </table>

    </div>

    <p-dialog header="Adicionar Serviço" [modal]="true" position="top" [(visible)]="showDialogServicos" [style]="{ width: '50rem' }">

        <p-table [value]="getServicosNaoSelecionados()">

            <ng-template pTemplate="header">
                <tr>
                    <th> Nome </th>
                    <th> SPREAD/Taxas </th>
                    <th class="small-column"></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr>
                    <td> {{item.nome}} </td>
                    <td class="force-center">
                        {{item.spred | number: '1.2-2' : 'pt-BR' }}% / {{item.taxas | number: '1.2-2' : 'pt-BR' }}
                    </td>
                    <td class="small-column">
                        <p-button icon="pi pi-plus" severity="secondary" size="small" (click)="addServico(item)" />
                    </td>
                </tr>
            </ng-template>

        </p-table>

        <ng-template pTemplate="footer">
            <p-button label="Cancel" [raised]="true" severity="secondary" (click)="showDialogServicos = false" />
        </ng-template>

    </p-dialog>

    <p-dialog header="Buscar Cotação" [modal]="true" position="top" [(visible)]="showDialogCotacao" [style]="{ width: '50rem' }">

        <div class="flex gap-4 items-center mb-8">

            <div class="flex-1 flex items-center justify-center">
                <label class="whitespace-nowrap">
                    Origem:
                </label>
            </div>

            <div class="flex-1">
                <app-select-moeda [(ngModel)]="moedaOrigem" />
            </div>

            <div class="flex-1 flex items-center justify-center">
                <label class="whitespace-nowrap">
                    Destino:
                </label>
            </div>

            <div class="flex-1">
                <app-select-moeda [(ngModel)]="moedaDestino" />
            </div>

            <div class="flex-none flex items-center">
                <p-button icon="pi pi-search" severity="success" (click)="buscarCotacao()" />
            </div>

        </div>

        @if (!loadingCotacoes()) {
        <p-table [value]="cotacoes">

            <ng-template pTemplate="header">
                <tr>
                    <th> Data </th>
                    <th> Taxa de Conversao </th>
                    <th class="small-column"></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr>
                    <td> {{item.data | date: "dd/MM/yyyy"}} </td>
                    <td class="force-center">
                        {{item.origem.simbolo}} {{ 1 | number: '1.2-2' : 'pt-BR'}} = {{item.destino.simbolo}} {{item.taxa | number: '1.2-2' : 'pt-BR'}}
                    </td>
                    <td class="small-column">
                        <p-button icon="pi pi-check" severity="secondary" size="small" (click)="setCotacao(item)" />
                    </td>
                </tr>
            </ng-template>

        </p-table>
        }

        <ng-template pTemplate="footer">
            <p-button label="Cancel" [raised]="true" severity="secondary" (click)="showDialogCotacao = false" />
        </ng-template>

    </p-dialog>

    <p-dialog header="Efetuar" [modal]="true" position="top" [(visible)]="showDialogEfetuar" [style]="{ width: '25rem' }">

        <div class="flex-1">
            <div class="flex mb-4">
                <div class="w-2/5 pr-2 flex items-center">
                    <label>Debitável:</label>
                </div>

                <div class="w-3/5">
                    <app-select-debitavel [debitaveis]="debitaveis" [(ngModel)]="debitavel" />
                </div>
            </div>
            <div class="flex mb-4">
                <div class="w-2/5 pr-2 flex items-center">
                    <label>Creditável:</label>
                </div>
                <div class="w-3/5">
                    <app-select-debitavel [debitaveis]="debitaveis" [(ngModel)]="creditavel" />
                </div>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Efetuar" [raised]="true" severity="secondary" (click)="efetuar()" />
        </ng-template>
    </p-dialog>
    }

</div>
<!-- <div class="overflow-x-auto p-4">
    <div class="flex space-x-4 min-w-max">
        <div *ngFor="let servico of servicos" class="w-72 flex-shrink-0">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="pi pi-money-bill text-blue-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-800">{{servico.nome}}</h3>
                    <span [class]="getTaxaBadgeClass(servico)" class="text-xs font-medium px-2 py-1 rounded-full mt-1 inline-block">
                        {{ servico.custoVariavel ? 'Taxa Variável' : 'Taxa Fixa' }}
                    </span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Spread:</span>
                        <span class="font-medium">{{servico.spred}}%</span>
                    </div>

                    <div class="flex justify-between text-sm items-center">
                        <span class="text-gray-600">Taxas:</span>
                        <div *ngIf="!servico.custoVariavel; else taxaVariavelInput" class="font-medium">
                            {{servico.taxas | currency:'BRL'}}
                        </div>
                        <ng-template #taxaVariavelInput>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">R$</span>
                                <input type="number"
                                       [(ngModel)]="servico.taxas"
                                       (ngModelChange)="calcularTotalLiquido(servico)"
                                       class="w-24 pl-8 pr-2 py-1 border border-gray-300 rounded text-sm text-right font-medium"
                                       placeholder="0,00"
                                       step="0.01"
                                       min="0">
                            </div>
                        </ng-template>
                    </div>

                    <div class="flex justify-between font-semibold border-t pt-2">
                        <span class="text-gray-700">Bruto:</span>
                        <span>{{calcularTotalBruto(servico) | currency:'BRL'}}</span>
                    </div>

                    <div class="flex justify-between text-green-600 font-bold mt-1 bg-green-50 p-2 rounded">
                        <span>Líquido:</span>
                        <span>{{calcularTotalLiquido(servico) | currency:'BRL'}}</span>
                    </div>

                    <div *ngIf="servico.custoVariavel && !servico.taxas"
                         class="bg-yellow-50 border border-yellow-200 rounded p-2">
                        <p class="text-yellow-800 text-xs">
                            <i class="pi pi-exclamation-triangle mr-1"></i>
                            Informe o valor da taxa
                        </p>
                    </div>
                </div>

                <button class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-md transition-colors">
                    Detalhes
                </button>
            </div>
        </div>
    </div>
</div> -->